<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Exercice 3</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- A-Frame 1.7.0 -->
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>

    <!-- A-Frame 1.5+ : éviter le conflit de nom "grabbable" -->
    <script> delete AFRAME.components["grabbable"]; </script>

    <!-- aframe-extras (sphere-collider) -->
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.2/dist/aframe-extras.min.js"></script>

    <!-- Physics system (CANNON/Ammo support) -->
    <script src="https://cdn.jsdelivr.net/npm/@c-frame/aframe-physics-system@4.1.0/dist/aframe-physics-system.min.js"></script>

    <!-- super-hands 3.x -->
    <script src="https://unpkg.com/super-hands@3.0.5/dist/super-hands.min.js"></script>

    <!-- Tes composants de déplacement + gun -->
    <script>
      // Déplacement joystick gauche
      AFRAME.registerComponent('joystick-movement', {
        schema: { speed: { type: 'number', default: 2 } },
        init: function () {
          const rig = document.querySelector('#rig');
          const head = document.querySelector('#head');
          const leftHand = document.querySelector('#leftHand');
          const speed = this.data.speed;
          const DEADZONE = 0.1;

          leftHand.addEventListener('thumbstickmoved', function (evt) {
            const dx = evt.detail.x, dy = evt.detail.y;
            if (Math.abs(dx) < DEADZONE && Math.abs(dy) < DEADZONE) return;

            const forward = new THREE.Vector3();
            head.object3D.getWorldDirection(forward);
            forward.y = 0; forward.normalize();

            const right = new THREE.Vector3();
            right.crossVectors(forward, new THREE.Vector3(0, 1, 0)).negate();

            const step = 0.05 * speed;
            const rigPos = rig.object3D.position;
            rigPos.addScaledVector(forward, dy * step);
            rigPos.addScaledVector(right,  dx * step);
          });
        }
      });

      // Rotation par crans (joystick droit)
      AFRAME.registerComponent('snap-turn', {
        schema: { angle: { type: 'number', default: 30 }, cooldown: { type: 'number', default: 300 } },
        init: function () {
          const rig = document.querySelector('#rig');
          const rightHand = document.querySelector('#rightHand');
          const angle = this.data.angle, cooldown = this.data.cooldown;
          let lastTurn = 0;
          rightHand.addEventListener('thumbstickmoved', function (evt) {
            const now = Date.now(), x = evt.detail.x;
            if (Math.abs(x) < 0.8 || now - lastTurn < cooldown) return;
            const rad = THREE.MathUtils.degToRad(angle);
            if (x > 0.8)  rig.object3D.rotation.y -= rad;
            else          rig.object3D.rotation.y += rad;
            lastTurn = now;
          });
        }
      });

      // Gun Shooting component
      AFRAME.registerComponent('gun-shoot', {
        schema: {
          hand: { type: 'selector' },
          bulletSpeed: { type: 'number', default: 40 }, // ajustable
          bulletLifetime: { type: 'number', default: 5000 } // ms
        },
        init: function () {
          const el = this.el;
          const hand = this.data.hand;
          const speed = this.data.bulletSpeed;
          const lifetime = this.data.bulletLifetime;

          // Position d'où sort la balle (doit être un enfant du modèle du gun)
          const shootPos = el.querySelector('#shootPos');

          // fallback si shootPos introuvable : tirer depuis la position locale du gun
          const getStartPos = () => {
            if (shootPos) {
              return shootPos.object3D.getWorldPosition(new THREE.Vector3());
            }
            return el.object3D.getWorldPosition(new THREE.Vector3());
          };

          // Trigger (bouton déclencheur)
          hand.addEventListener('triggerdown', () => {
            // Tir uniquement si l'arme est saisie
            if (!el.is('grabbed')) return;

            // Création de la balle
            const bullet = document.createElement('a-sphere');
            const startPos = getStartPos();

            // Position & apparence
            bullet.setAttribute('position', `${startPos.x} ${startPos.y} ${startPos.z}`);
            bullet.setAttribute('radius', 0.05);
            bullet.setAttribute('color', '#ff3333');
            bullet.setAttribute('shadow', 'cast: true; receive: false');

            // Physique : corps dynamique (masse petite)
            bullet.setAttribute('dynamic-body', 'mass: 0.1; shape: sphere');

            // Ajout à la scène
            el.sceneEl.appendChild(bullet);

            // Calculer direction avant du shootPos (ou du gun) et appliquer vitesse
            const direction = new THREE.Vector3();
            if (shootPos) {
              shootPos.object3D.getWorldDirection(direction);
            } else {
              // fallback : direction avant du gun wrapper
              el.object3D.getWorldDirection(direction);
            }
            direction.normalize();

            // Appliquer la vitesse lorsque le body est chargé
            bullet.addEventListener('body-loaded', () => {
              // Méthode simple : setAttribute velocity (supportée par aframe-physics-system)
              const vx = direction.x * speed;
              const vy = direction.y * speed;
              const vz = direction.z * speed;
              bullet.setAttribute('velocity', `${vx} ${vy} ${vz}`);

              // Optionnel : on peut aussi appliquer un impulse via cannon body si nécessaire
              // const body = bullet.body;
              // body.velocity.set(vx, vy, vz);
            });

            // Nettoyage après un certain temps
            setTimeout(() => {
              if (bullet.parentNode) bullet.parentNode.removeChild(bullet);
            }, lifetime);
          });
        }
      });
    </script>
  </head>

  <body>
    <a-scene
      shadow="type: pcfsoft"
      renderer="antialias: true"
      vr-mode-ui="enabled: true"
      device-orientation-permission-ui="enabled: true"
      physics="gravity: -9.8; debug: false"
    >
      <!-- Assets : remplace les chemins si besoin -->
      <a-assets>
        <img id="skyTexture" src="./skynet.jpg" />
        <img id="groundTexture" src="./grass.jpg" />
        <!-- Ton modèle GLTF : scene.gltf (doit être accompagné de scene.bin dans le même dossier) -->
        <a-asset-item id="gunModel" src="./assets/scene.gltf"></a-asset-item>
      </a-assets>

      <!-- Lumières -->
      <a-entity light="type: ambient; intensity: 0.4"></a-entity>
      <a-entity light="type: directional; intensity: 1; castShadow: true" position="2 4 -2"></a-entity>

      <!-- RIG + caméra + contrôleurs -->
      <a-entity id="rig" position="0 1 0" joystick-movement="speed: 2" snap-turn="angle: 30; cooldown: 300">
        <a-entity id="head" camera wasd-controls-enabled="false" look-controls></a-entity>

        <!-- Mains : super-hands limité au bouton grip (side) + collision par sphère -->
        <a-entity id="leftHand"
          oculus-touch-controls="hand: left"
          super-hands="grabStartButtons: gripdown, squeezestart; grabEndButtons: gripup, squeezeend"
          sphere-collider="objects: .grabbable"
          static-body="shape: sphere; sphereRadius: 0.03">
        </a-entity>

        <a-entity id="rightHand"
          oculus-touch-controls="hand: right"
          super-hands="grabStartButtons: gripdown, squeezestart; grabEndButtons: gripup, squeezeend"
          sphere-collider="objects: .grabbable"
          static-body="shape: sphere; sphereRadius: 0.03">
        </a-entity>
      </a-entity>

      <!-- OBJETS SAISISSABLES (physiques) -->
      <a-box class="grabbable" position="-1 0.6 -1.6" rotation="0 45 0" color="#4CC3D9"
             shadow="cast: true; receive: true"
             grabbable="usePhysics: only; startButtons: gripdown, squeezestart; endButtons: gripup, squeezeend"
             dynamic-body="mass: 1; shape: box">
      </a-box>

      <a-sphere class="grabbable" position="0 1.2 -2" radius="0.5" color="#EF2D5E"
                shadow="cast: true; receive: true"
                grabbable="usePhysics: only; startButtons: gripdown, squeezestart; endButtons: gripup, squeezeend"
                dynamic-body="mass: 0.5; shape: sphere">
      </a-sphere>

      <a-cylinder class="grabbable" position="1 0.9 -2.4" radius="0.4" height="1" color="#FFC65D"
                  shadow="cast: true; receive: true"
                  grabbable="usePhysics: only; startButtons: gripdown, squeezestart; endButtons: gripup, squeezeend"
                  dynamic-body="mass: 0.75; shape: cylinder">
      </a-cylinder>

      <!-- Gun wrapper (saisissable) : adapte position/scale selon ton modèle -->
      <a-entity id="GunWrapper"
        class="grabbable"
        position="2.531 1.2 -1.0"
        rotation="0 0 0"
        scale="1 1 1"
        shadow="cast: true; receive: true"
        geometry="primitive: box; width: 0.5; height: 0.15; depth: 0.05"
        material="opacity: 0; transparent: false"
        grabbable="usePhysics: only; startButtons: gripdown, squeezestart; endButtons: gripup, squeezeend"
        dynamic-body="mass: 1; shape: box"
        gun-shoot="hand: #rightHand; bulletSpeed: 45; bulletLifetime: 5000">

        <!-- Modèle GLTF du pistolet -->
        <a-entity id="gunModelInScene"
          gltf-model="#gunModel"
          position="0 0 0"
          rotation="0 0 0"
          scale="0.1 0.1 0.1"
          shadow="cast: true; receive: true">
          <!-- shootPos : point d'émission des balles (à ajuster selon l'orientation du model) -->
          <a-entity id="shootPos" position="0.2 0.05 -0.35"></a-entity>
        </a-entity>
      </a-entity>
      <!-- Table sur laquelle le pistolet est posé -->
      <a-box position="2.5 0.75 -1" rotation="0 0 0" width="1" height="0.1" depth="1" color="#8B4513"
             shadow="cast: true; receive: true" static-body>
      </a-box>

      <!-- Sol -->
      <a-plane position="0 0 -1" rotation="-90 0 0" width="100" height="100" src="#groundTexture"
               shadow="cast: false; receive: true"
               static-body>
      </a-plane>

      <a-sky src="#skyTexture"></a-sky>
    </a-scene>
  </body>
</html>
